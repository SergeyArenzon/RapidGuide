replicaCount: 1

image:
  repository: sergeyarenzon/huddlehub-auth
  tag: latest
  pullPolicy: IfNotPresent

# Add init containers to wait for dependencies
initContainers:
  - name: wait-for-auth-db
    image: busybox
    env:
      - name: AUTH_DB_PORT
        valueFrom:
          configMapKeyRef:
            name: auth-db-config
            key: POSTGRES_PORT
  #   command: ["/bin/sh", "-c", "until nc -z -v -w30 auth-db $AUTH_DB_PORT; do echo 'Waiting for PostgreSQL...'; sleep 5; done"]
  # - name: wait-for-redis
  #   image: busybox:1.35
  #   command: ['sh', '-c', 'until nc -z redis-master 6379; do echo waiting for redis; sleep 2; done; echo "Redis is ready!";']

service:
  type: ClusterIP
  port: 3000

resources:
  limits:
    cpu: 500m
    memory: 1Gi
  requests:
    cpu: 100m
    memory: 150Mi

# autoscaling:
#   enabled: false
#   minReplicas: 1
#   maxReplicas: 3
#   targetCPUUtilizationPercentage: 80

env:
  NODE_ENV: production
  JWT_MAX_AGE: 3600000
  # 15 minutes in milliseconds: 15 * 60 * 1000 = 900000
  JWT_ACCESS_EXPIRES_IN_MS: 900000
  # 7 days in milliseconds: 7 * 24 * 60 * 60 * 1000 = 604800000
  JWT_REFRESH_EXPIRES_IN_MS: 604800000
  GOOGLE_REDIRECT_URI: http://localhost:80/api/v1/auth/auth/callback/google
  CLIENT_URL: http://localhost:3000
  # Explicit BETTER_AUTH_URL prevents Better-Auth from falling back to BASE_URL
  # (which is set globally to http://localhost/api/v1 via envFrom and would break routing).
  # Must match the internal path where requests arrive after ingress rewrite: /auth/*
  BETTER_AUTH_URL: http://localhost/auth
  # Redis credentials will be loaded from global secrets
  # Add other environment variables as needed

# configMaps:
#   rabbitmq:
#     name: rabbitmq-config

postgresql:
  enabled: true
  auth:
    username: postgres
    password: postgres
    database: auth_db
  persistence:
    size: 8Gi


# Secrets are now created directly by Skaffold from .env using kubectl
# See skaffold.dev.yaml hooks section
# - global-secrets: JWT_SECRET, REDIS_PASSWORD
# - auth-secrets: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET

configMaps:
  auth-db:
    name: auth-db-config
    keys:
      POSTGRES_HOST: auth-db
      POSTGRES_PORT: 5432
      POSTGRES_DB: auth
      POSTGRES_USER: postgres
  # global:
  #   name: global-config
  #   keys:
  #     redis-host: redis-host
  #     redis-port: redis-port
  #     redis-db: redis-db

database:
  password: "postgres" 